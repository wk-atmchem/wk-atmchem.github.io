---
layout:     post
title:      CMAQ5.3.1安装教程
subtitle:   空气质量模型 
date:       2020-04-22
author:     吴锴
header-img: img/cmaq-tdep.png
catalog: true
tags:
    - 科研
    - 博客
    - 漫谈
---

# 关于分享

平时经常有很多人来请教我关于CMAQ模型编译，使用，debug的问题，我都花时间为其一一解答。

感觉在解答别人的问题时，你自己也能学到很多新的知识，同时能沉浸其中。

我想这就是分享的魔力吧。

感谢US EPA的Dr.David C. Wong， Dr.Christian Hogrefe，香港理工大学刘一鸣博士，北京市劳动保护科学研究所王堃博士，清华大学环境学院张芬芬博士，美国田纳西大学谈佳妮博士，南京信息工程大学张昕博士对我的指导和帮助。

下面我们开始进入CMAQ的世界~

# CMAQ整体框架介绍
CMAQ作为美国环保署开发的第三代欧拉空气质量模型，因其高时空分辨率，多工具成体系化而被广泛应用于大气环境科学研究当中。
CMAQ的官网为https://www.epa.gov/cmaq

目前所有版本的CMAQ源代码均托管在github上，网址为https://github.com/USEPA/CMAQ

下图即为CMAQ整体的模型框架以及相关的前处理，后处理工具。
![CMAQ-structure](https://raw.githubusercontent.com/wk-atmchem/wk-atmchem.github.io/master/img/CMAQ-structure.png)


# CMAQv5.3.1所需库安装
US EPA指出安装CMAQv5.3.1所需的库为以下几个:netCDF-C, netCDF-Fortran, IOAPI以及MPI(MPI为并行计算所需)。

本文以EPA官方Tutorials为参考，使用以下的库版本：netcdf-c-4.7.0,netcdf-fortran-4.4.5,ioapi-3.2

为方便大家获取库文件的压缩包，我已将上述3个库上传至百度网盘：
链接：https://pan.baidu.com/s/1-VB2MlW7MFCcM3SeL2FYvg 
提取码：v42k

下面我们开始按顺序安装上述3个库：

## I.安装netCDF-C

在Linux的terminal中按顺序输入如下命令：

1.`tar -xzvf netcdf-c-4.7.0.tar.gz`

这一步即为解压netcdf-c的这个tar包，解压完成后会在当前路径下出现一个netcdf-c-4.7.0的文件夹
如下图所示：
![netcdf-ctar](https://raw.githubusercontent.com/wk-atmchem/wk-atmchem.github.io/master/img/netcdf-ctar.png)

2.`cd netcdf-c-4.7.0` 进入netcdf-c-4.7.0文件夹

然后输入`ls`发现文件夹内部结构如下
![netcdf-c2](https://raw.githubusercontent.com/wk-atmchem/wk-atmchem.github.io/master/img/netcdf-c2.png)

3.`mkdir ../netcdf-c-4.7.0-intel` 

这步即为在解压出来的netcdf-c目录的上一层目录创建一个名为netcdf-c-4.7.0-intel的文件夹

4.`cd ../netcdf-c-4.7.0-intel`
进入步骤3创建的名为netcdf-c-4.7.0-intel的文件夹

5.`pwd`
通过pwd命令得知当前文件夹的路径
以本文为例，路径为/home/kai/lib/new/netcdf-c-4.7.0-intel

6.`./configure --prefix=/home/kai/lib/new/netcdf-c-4.7.0-intel --disable-netcdf-4 --disable-dap` 
执行编译

7.`make check install` 

对安装结果进行测试  是否成功编译   如编译成功   则会出现如下提示：
Congratulations! You have successfully installed netCDF!
![netcdf-c3](https://raw.githubusercontent.com/wk-atmchem/wk-atmchem.github.io/master/img/netcdf-c3.png)

8.`cd /home/kai/lib/new/netcdf-c-4.7.0-intel`
进入目标文件夹查看   是否成功安装


## II.安装netCDF-Fortran

在Linux的terminal中按顺序输入如下命令：

1.`tar -zxvf netcdf-fortran-4.4.5.tar.gz` 

这一步即为解压netcdf-fortran的这个tar包，解压完成后会在当前路径下出现一个netcdf-fortran-4.4.5的文件夹
如下图所示：
![netcdf-ff1](https://raw.githubusercontent.com/wk-atmchem/wk-atmchem.github.io/master/img/netcdff1.png)

2.`cd netcdf-fortran-4.4.5` 进入netcdf-fortran-4.4.5文件夹  然后`ls`查看当前文件夹下的文件 发现内部结构如下
![netcdf-ff2](https://raw.githubusercontent.com/wk-atmchem/wk-atmchem.github.io/master/img/netcdff2.png)

3.`mkdir ../netcdf-f-4.4.5-intel` 

这步即为在解压出来的netcdf-f目录的上一层目录创建一个名为netcdf-f-4.4.5-intel的文件夹

4.`cd ../netcdf-f-4.4.5-intel`
进入步骤3创建的名为netcdf-f-4.4.5-intel的文件夹

5.`pwd`
通过pwd命令得知当前文件夹的路径
以本文为例，路径为/home/kai/lib/new/netcdf-f-4.4.5-intel

6.利用以下命令执行编译`./configure --prefix=/home/kai/lib/new/netcdf-f-4.4.5-intel LDFLAGS="-L/home/kai/lib/new/netcdf-c-4.7.0-intel/lib" CPPFLAGS="-I/home/kai/lib/new/netcdf-c-4.7.0-intel/include" CC=icc FC=ifort` 
注意点：在编译netcdf-f的时候，我们需要调用netcdf-c的2个库的位置LDFLAGS和CPPFLAGS分别代表地址。因此，我们需要先编译netcdf-c，再编译netcdf-f。


7.`make check`
执行make check后  经过一系列Testuite Summary之后出现下图即为成功
![makecheck](https://raw.githubusercontent.com/wk-atmchem/wk-atmchem.github.io/master/img/makecheck.png)

8.`make install`
执行make install后  出现下图即为成功安装
![makeinstall](https://raw.githubusercontent.com/wk-atmchem/wk-atmchem.github.io/master/img/makeinstall.png)
